(function(e){function p(e){if(!e||typeof e!="string")throw new Error("Argument to ISOToDate must be a string");var t=parseInt(e.slice(0,4),10),n=parseInt(e.slice(5,7),10)-1,r=parseInt(e.slice(8,10),10),i=parseInt(e.slice(11,13),10),s=parseInt(e.slice(14,16),10),o=parseInt(e.slice(17,19),10),u=new Date(t,n,r,i,s,o);return u}function d(e){var t={showMain:!1,showYear:!1,showMonth:!1};return e?typeof e=="boolean"?(t.showMain=e,t):typeof e=="object"?(t.showMain=!!e.main,t.showYear=!!e.year,t.showMonth=!!e.month,t):t:t}function v(t){return e.map(t.split("-"),function(e,t){return t===1?parseInt(e,10)-1:parseInt(e,10)})}function m(e,t){var n=e.width<t.width?t.width:e.width,r=e.height<t.height?t.height:e.height,e={width:n,height:r,autoGrow:e.autoGrow};return e}function g(e,t){var n=e.width,r=e.height,i=t===u[1]?{width:n/7,height:r/6}:{width:n/7,height:r};return i}var t="mcalendar",n="mcalendar-label",r="<div class='"+t+"'> </div> <div class='"+n+" label-main'> </div>",i={width:50,height:50},s={width:50,height:10},o={width:600,height:50,autoGrow:!1},u=["week","month","full"],a=["January","February","March","April","May","June","July","August","September","October","November","December"],f=d3.time.format("%w"),l=d3.time.format("%Y-%m"),c=d3.time.format("%Y-%m-%d"),h;h=function(n){var r=this,a=n,f=a.viewMode&&e.inArray(a.viewMode,u)!==-1?a.viewMode:u[2],l,c,h,p;r.anchorSelector=a.rootSelector+" ."+t,r.$mainLabel=e(a.rootSelector+" .label-main"),r.$root=e(a.rootSelector),c=f===u[0]?s:f===u[1]?i:o,l={width:r.$root.width(),height:r.$root.height()},h=n.dimensions?m(n.dimensions,c):m(l,c),r.mode=f,r.dimensions=h,r.meta=a.meta||{},r.showLabel=d(a.showLabel),r.data=a.data,r.margin=a.margin||{t:0,r:0,b:0,l:0},r.timestamp=a.accessors&&a.accessors.getTimestamp?a.accessors.getTimestamp:function(e){return e._groupby},r.counts=a.accessors&&a.accessors.getCount?a.accessors.getCount:function(e){return e._count},r.onclick=a.events&&a.events.onclick?a.events.onclick:e.noop,r.onmouseover=a.events&&a.events.onmouseover?a.events.onmouseover:e.noop,p=f===u[2]?r._renderFullView:f===u[0]?r._renderWeekView:r._renderMonthView,p.apply(this),r.$mainLabel.html(r.dateData.strDate),r.showLabel.showMain||e(a.rootSelector+" .label-main").hide(),r.showLabel.showYear||e(a.rootSelector+" .label-year").hide(),r.showLabel.showMonth||e(a.rootSelector+" .label-month").hide()},h.prototype._renderWeekView=function(){var e=this;e._createSvg(),e.cellSize=g(e.dimensions,e.mode),e._preprocessDataWeekView(),e._initWeekGrid()},h.prototype._renderMonthView=function(){var e=this;e._createSvg(),e.cellSize=g(e.dimensions,e.mode),e._preprocessDataMonthView(),e._initGenericMonthGrid()},h.prototype._renderFullView=function(){var e=this;e._preprocessDataFullView(),e._createSvgForFullView()},h.prototype._nestData=function(e,t){var n=this,r=n.timestamp,i=d3.nest().key(function(t){return e(p(r(t)))}).entries(t);return i},h.prototype._preprocessDataWeekView=function(){var e=this,t=c,n=[],r,i;i=e._nestData(t,e.data),i.length>7&&console.log("Warning: Data array contains elements that span over 7 days. Taking the first 7 days only"),r=v(i[0].key),i.forEach(function(e){n[e.key]=e.values}),e.dateData={month:r[1],year:r[0],day:r[2],strDate:i[0].key,data:n}},h.prototype._preprocessDataMonthView=function(){var e=this,t=l,n=c,r={},i=e.data,s,o;o=e._nestData(t,i),o.length>1&&console.log("Warning: Data array contains elements that span several months. Taking the first month only"),s=v(o[0].key),d3.nest().key(function(t){return n(p(e.timestamp(t)))}).entries(o[0].values).forEach(function(e){r[e.key]=e.values}),e.dateData={month:s[1],year:s[0],strDate:a[s[1]]+" "+s[0],data:r}},h.prototype._preprocessDataFullView=function(){var e=this,t={},n=e.data,r=l,i=c,s,o;o=d3.nest().key(function(t){return r(p(e.timestamp(t)))}).key(function(t){return i(p(e.timestamp(t)))}).entries(n),s=d3.extent(o,function(e){return e.key}),o.forEach(function(e){var n={};e.values.forEach(function(e){n[e.key]=e.values}),t[e.key]=n}),e.dateData={startRange:v(s[0]),endRange:v(s[1]),strDate:s[0]+"/"+s[1],data:t}},h.prototype._createSvg=function(){var e=this,t=e.dimensions.width,n=e.dimensions.height,r=e.mode;e.svg=d3.select(e.anchorSelector).append("svg").attr("class","svg-window").attr("class","calendar-"+r).attr("width",t).attr("height",n).append("g")},h.prototype._initWeekGrid=function(){var e=this,t=e.dateData,n=t.data,r=c,i=e._datum.bind(this,r,n),s=e.cellSize,o=0,u;u=d3.time.days(new Date(t.year,t.month,t.day),new Date(t.year,t.month,t.day+7)),e.rect=e.svg.selectAll(".day").data(u).enter().append("rect").attr("width",s.width).attr("height",s.height).attr("x",function(e){return o++*s.width}).datum(i).on("click",e.onclick).on("mouseover",e.onmouseover),e._finishLabelling()},h.prototype._initGenericMonthGrid=function(e,t,n,r){function p(t){return h=t.getDate()===1?parseInt(s(t),10):h+1,Math.floor(h/7)*e.height}var i=this,s=f,o=c,e=e||i.cellSize,u=t||i.dateData.data,a=r?d3.select(r):i.svg,l=i._datum.bind(this,o,u),n=n||d3.time.days(new Date(i.dateData.year,i.dateData.month,1),new Date(i.dateData.year,i.dateData.month+1,1)),h=0;i.rect=a.selectAll(".day").data(n).enter().append("rect").attr("width",e.width).attr("height",e.height).attr("x",function(t){return s(t)*e.width}).attr("y",p).attr("class","day").datum(l).on("click",i.onclick).on("mouseover",i.onmouseover),i._finishLabelling()},h.prototype._datum=function(e,t,n){var r=this,i=t||{},s=e(n),o=i[e(n)]||[],u=d3.sum(o,r.counts);return{date:s,matches:o,sumMatchCount:u,meta:r.meta}},h.prototype._finishLabelling=function(){function t(e){var t="day ";return e.matches.length>0&&(t+="matched "),e.sumMatchCount>0&&(t+="hascount"),t}var e=this;e.rect.attr("class",t).append("title").text(function(e){return e.date})},h.prototype._createSvgForFullView=function(){var t=this,r=t.margin,i=t.dateData,s=i.endRange[0]-i.startRange[0]+1,o=t.dimensions.autoGrow?t.dimensions.height-2:Math.floor(t.dimensions.height/s)-2,u=t.dimensions.width,f=o-2-r.t-r.b,l=u/12-2-r.l-r.r,c={width:Math.floor(l/7),height:f/6},h=d3.time.format("%Y-%m");t.yearWrapper=d3.select(t.anchorSelector).selectAll("div").data(d3.range(i.startRange[0],i.endRange[0]+1)).enter().append("div").attr("class",function(e){return"calendar-year d"+e}).attr("style",function(e){return"width:"+u+"px; height:"+o+"px; position:relative"}),t.yearWrapper.append("div").attr("class",n+" label-year").attr("style","position:absolute;").text(function(e){return e}),t.monthsWrapper=t.yearWrapper.selectAll(".calendar-year").data(function(e){return d3.time.months(new Date(e,0,1),new Date(e,12,1)).map(function(e){return h(e)})}).enter().append("div").attr("class","month-wrapper-do-not-style").attr("style","display:inline-block; position: relative").append("svg").attr("class",function(e){return"calendar-month d"+e}).attr("width",l).attr("height",f).attr("style",function(e){return"margin:"+r.t+"px "+r.r+"px "+r.b+"px "+r.l+"px; -webkit-box-sizing: border-box;"}),t.monthsWrapper.append("g").each(function(r){var i=v(r),s=d3.time.days(new Date(i[0],i[1],1),new Date(i[0],i[1]+1,1));e(this.parentNode.parentNode).append("<div class='"+n+" label-month' style='position:absolute;'>"+a[i[1]]+"</div>"),t._initGenericMonthGrid(c,t.dateData.data[r],s,t.anchorSelector+" .d"+r+" g")})};var y={init:function(n){var i=this.data(t),s=n||{},o;return this.length>1?(console.error("Warning: you can only initialize one element at a time"),this):i&&i.calendar?(console.error("Warning: this element has already been initialized as an mcalendar"),this):d3?s.data?(this.html(r),o=new h({rootSelector:this.selector,viewMode:s.viewMode,dimensions:s.dimensions,margin:s.margin,data:s.data,showLabel:s.showLabel,accessors:s.accessors,meta:s.meta,events:s.events}),e(this).data(t,{calendar:o}),this):(console.error("Warning: A data array needs to be passed in"),this):(console.error("Warning: d3 library not loaded"),this)},reset:function(){return this}};e.fn.mcalendar=function(t){if(y[t])return y[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t=="object"||!t)return y.init.apply(this,arguments);e.error("Method "+t+" does not exist on jQuery.mcalendar")}})(jQuery);